@model HmsService.ViewModels.OrderViewModel
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap.min.css" rel="stylesheet" />
<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
<link rel="stylesheet" href="~/Content/sweetalert2.min.css">

<div class="container">
    <div class="row">
        <div class="col-xs-11">
            <h2>Order</h2>
            <table id="orderTable" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Order Date</th>
                        <th>Status</th>
                        <th>Total Bill</th>
                        <th>Delivery Address</th>
                        <th>Receiver Name</th>
                        <th>Receiver Phone</th>
                        <th>Order Details</th>
                        <th>Update</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<div class="modal" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                @*<button class="close" data-dismiss="modal">&times;</button>*@
                <h4 class="modal-title">Order Details</h4>
            </div>
            <div class="modal-body">
                <table id="orderDetailsTable" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Total Amount</th>
                            <th>Size</th>
                            <th>Color</th>
                        </tr>
                    </thead>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="EditStatusModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                @*<button class="close" data-dismiss="modal">&times;</button>*@
                <h4 class="modal-title">Edit Status</h4>
            </div>
            <div class="modal-body">
                <div class="dropdown">
                    <h3>Update status</h3>
                    <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Choose Status
                    </button>
                    <input type="hidden" id="EditOrderId" />
                    <div id="statusList" class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                        <a class="dropdown-item" href="#">Dispose</a>
                        <a class="dropdown-item" href="#">Finish</a>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" value="submit" id="btnUpdateStatus" class="btn btn-primary">Update</button>
                <button class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
@section scripts{
    <script src="//cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap.min.js"></script>
    <script src="~/Scripts/sweetalert2.all.min.js"></script>
    <script src="//cdn.datatables.net/plug-ins/1.10.19/dataRender/datetime.js"></script>

    <script>
        var orderDetailsDataTable;
        function GetDetails(ID) {
            orderDetailsDataTable != null ? orderDetailsDataTable.destroy() : "";
            //orderDetailsDataTable != null ? orderDetailsDataTable.clear() : "";
            //$("#orderDetailsTable tr").remove();;
            orderDetailsDataTable = $("#orderDetailsTable").DataTable({
                ajax: {
                    url: '@Url.Action("GetOrderDetails", "OrderDetails")',
                    type: 'get',
                    data: {
                        "orderID": ID
                    }
                },
                columns: [
                    { data: "Product.Name"},
                    { data: "Quantity"},
                    { data: "Amount"},
                    { data: "Price" },
                    { data: "Size" },
                    { data: "Color"},
                ],
            });
        }
        function setEditStatusId(ID) {
            $('#EditOrderId').val(ID);
        }
        $('#statusList a').on('click', function () {
            $('#dropdownMenuButton').text($(this).text());
            switch ($(this).text()) {
                case 'Dispose':
                    $('#dropdownMenuButton').val(2);
                    break;
                case 'Finish':
                    $('#dropdownMenuButton').val(3);
                    break;
            }
        });

        $(document).ready(function () {
            var table;
            InitDataTable();
            function InitDataTable() {
                table = $("#orderTable").DataTable({
                    "ajax": {
                        "type": "GET",
                        "url": "@Url.Action("GetAllOrders", "Order")"
                    },
                    columns: [
                        { data: "Customer.Name" },
                        {
                            data: 'CheckInDate',
                            render: function (data, type, row) {
                                var date = new Date(parseInt(data.substr(6).replace(")/", ""))).toLocaleString();
                                return date;
                            },
                        },
                        {
                            data: "Status",
                            render: function (data, type, row) {
                                switch (data) {
                                    case 1:
                                        type = 'New';
                                        color = "<div class='label label-primary myCategory'>";
                                        break;
                                    case 2:
                                        type = 'Dispose';
                                        color = "<div class='label label-warning myCategory'>";
                                        break;
                                    case 3:
                                        type = 'Finish';
                                        color = "<div class='label label-success myCategory'>";
                                        break;
                                }
                                return color + type + '</div>';
                            }
                        },
                        { data: "TotalAmount" },
                        { data: "DeliveryAddress" },
                        { data: "ReceiverName" },
                        { data: "ReceiverPhone" },
                        {
                            data: 'ID',
                            render: function (data, type, row) {
                                return '<button class="btn btn-success btn-sm" data-target="#orderDetailsModal" data-toggle="modal" onclick="GetDetails(' + data + ')"><i class="fa fa-eye"></i></button>';
                            },
                            orderable: false
                        },
                        {
                            data: 'ID',
                            render: function (data, type, row) {
                                return '<button class="btn btn-primary btn-sm" data-target="#EditStatusModal" data-toggle="modal" onclick="setEditStatusId(' + data + ')"><i class="fa-pencil-square-o" style="font-size:18px;"></i></button>'
                            },
                            orderable: false
                        }
                    ],
                });

            }
            $("#btnUpdateStatus").click(function () {
                updateStatus();
            }); 
            function updateStatus() {
                var formData = new FormData();
                formData.append('ID', $("#EditOrderId").val());
                formData.append('Status', $("#dropdownMenuButton").val());
                $.ajax({
                    url: "@Url.Action("UpdateStaus", "Order")",
                    method: "post",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        if (data.success) {
                            swal({
                                type: 'success',
                                title: 'success!',
                            });
                            $("#EditStatusModal").modal('hide');
                            table.ajax.reload(null, false);
                        }
                    },
                    error: function (data) {
                        swal({
                            type: 'error',
                            title: 'error!',
                        });
                    }
                });
            }
        });

    </script>
}
